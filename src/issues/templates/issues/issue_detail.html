{% extends "base.html" %}
{% load i18n %}
{% load humanize %}
{% load crispy_forms_tags %}


{% block extra-page-id %}
id="issue-detail"
{% endblock %}


{% block page_header %}
    {% trans "Issue" %}
{% endblock %}


{% block header-start %}
    {% if cperms.issues.editclosed_issue or not object.is_archived %}
        {% if cperms.issues.editopen_issue or object.created_by == user %}
            <a href="#issuepanel" data-icon="bars" data-iconpos="notext"  data-rel="panel"></a>
        {% else %}
        <a href="#" style="visibility:hidden"></a>
        {% endif %}
    {% else %}
        <a href="#" style="visibility:hidden"></a>
    {% endif %}
{% endblock %}

{% block endpanel %}
    <div data-role="panel" id="issuepanel">
        <ul data-role="listview">
            {% if cperms.issues.editclosed_issue or not object.is_archived %}
                {% if cperms.issues.editopen_issue or object.created_by == user %}
                    <li>
                        <a data-rel="form" href="{{object.get_edit_url}}">{% trans "Edit" %}</a>
                    </li>
                    
                    {% if cperms.issues.editopen_issue %}
                        <li>
                            <a id="add-attachment"  data-rel="form" 
                                href="{% url 'add_attachment' community.id object.id %}"> {% trans 'Add attachment' %} </a>
                        </li>
                    {% endif %}
                    
                    <li>
                        <a data-rel="form" href="{{object.get_delete_url}}">{% trans "Delete" %}</a>
                    </li>
                {% endif %}
            {% endif %}
        </ul>
    </div>
{% endblock %}

{% block content %}

    {% if object.is_archived %}

        <p class="sub-title">
            --{% trans "Closed" %}--
        </p>

    {% else %}

        {% if object.is_upcoming %}
            <p class="sub-title">
                --{% trans "In upcoming meeting" %}--
            </p>
        {% endif %}

    {% endif %}

    <table class="table table-condensed issue-detail-table">
        <tr>
            <td class="icon" rowspan="2"></td>
            <td class="title">{{object.title}}</td>
        </tr>
        <tr>
            <td class="name">{{ object.created_by}} ({{ object.created_at}})</td>
        </tr>
    </table>

    {% if object.abstract %}

        {# h4 class="abstract">{% trans "Abstract" %}</h4> #}

        <div class="proposal-info no-margin">
            <p>
                {{object.abstract|safe}}
            </p>
        </div>
    {% endif %}

    {% if object.content %}

        <h4 class="abstract">{% trans "Content" %}</h4>

        <div class="proposal-info">
            <p>
                {{object.content|safe}}
            </p>
        </div>

    {% endif %}


    <div class="issue_attachments">
        <span class="loader">
            <img src="{{STATIC_URL}}images/ajax-loader.gif" alt="Loading"/>
        </span>
        
        {% if object.attachments.count %}
            <ul>
                {% for att in object.attachments.all %}
                    <li><a href="{{ att.get_absolute_url }}">{{ att.title }}</a>
                    {% if cperms.issues.editopen_issue %}
                        <a id="remove-attachment" href="{% url 'attachment_delete' community.id object.id att.id %}" data-rel="form"><img src="{{ STATIC_URL }}/images/icon-remove.gif"/></a></li>
                    {% endif %}
                {% endfor %}
            </ul>
        {% endif %}
        
    </div>


    {% if object.proposals.active.count %}
        <div class="issue_proposal">

            <h4>{% trans "Past Proposals" %}</h4>

            {% for proposal in object.proposals.closed %}
                {% include 'issues/_proposal.html' %}
            {% endfor %}

            <h4>{% trans "Proposals" %}</h4>

            {% for proposal in object.proposals.open %}
                {% include 'issues/_proposal.html' %}
            {% endfor %}

        </div>
    {% endif %}

    {% if cperms.issues.add_proposal and not object.is_archived %}
        <div class="narrow clear">
            <a data-role="button" data-rel="form" data-theme="a"
            href="{% url "proposal_create" community.id object.id %}">{% trans "Add Proposal" %}</a>
        </div>
    {% endif %}

    {% if object.comments.count or cperms.issues.add_issuecomment and object.community.upcoming_meeting_started and object.is_upcoming %}
        <div class="issuecomments">
            <h4>{% trans "Summary" %}</h4>
            <ul data-role="listview" id="comments">
                {% for c in object.comments.all %}
                    {% include "issues/_comment.html" %}
                {% endfor %}
                {% if cperms.issues.add_issuecomment and object.community.upcoming_meeting_started and object.is_upcoming %}
                    <li>
                        {% crispy form %}
                    </li>
                {% endif %}
            </ul>
        </div>
    {% endif %}

    {% if cperms.meetings.add_meeting and object.community.upcoming_meeting_started and object.status == object.statuses.IN_UPCOMING_MEETING %}
        <br/>
        <form id="issue-complete" method="post" action="{% url 'issue_complete' community.id issue.id %}">
            {% csrf_token %}
            <input name="enable" type="hidden" value="{{object.completed|yesno:'0,1'}}"/>
            <div class="narrow">
                <button data-theme="b">
                    {% if object.completed %}{% trans "Undo complete discussion" %}{% else %}{% trans "Complete discussion" %}{% endif %}
                </button>
            </div>
        </form>
        <br/>
    {% endif %}

{% endblock %}

{% block extrahead %}
    <link rel="stylesheet" href="{{STATIC_URL}}css/issue.css"/>
{% endblock %}

{% block scripts %}
    <script src="{{STATIC_URL}}js/issue.js"></script>
{% endblock %}
